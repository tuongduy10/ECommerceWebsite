@using Microsoft.Extensions.Configuration
@inject IConfiguration Configuration
@{
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}
<script src="https://cdn.tiny.cloud/1/4ctr9pi6o8mlflu8si6gdszgl62tn4zl73knhf3tkqalszsx/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
<div class="container-fluid">
    <!-- DataTales Example -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary text-center">Thêm sản phẩm</h6>
        </div>
        <div class="card-body p-2">
            <form class="mx-auto">
                <div class="row">
                    <div class="col-sm-6 mb-4">
                        <div class="text-left mb-2 text-primary"><strong>Thông tin cơ bản</strong></div>
                        <div class="form-group mb-4">
                            <label>Tên sản phẩm</label>
                            <input type="text" class="form-control pro-name" value="">
                        </div>
                        <div class="form-group mb-4">
                            <label>Giá có sẵn</label>
                            <div class="d-flex align-items-center">
                                <input type="number" class="form-control pro-pricepreorder" value="" min="0" step="1000">
                            </div>
                        </div>
                        <div class="form-group mb-4">
                            <label>Giá đặt trước</label>
                            <div class="d-flex align-items-center">
                                <input type="number" class="form-control pro-priceavailable" value="" min="0" step="1000">
                            </div>
                        </div>
                        <div class="form-group mb-4">
                            <label>Giảm giá</label>
                            <div class="form-check mb-4">
                                <input class="form-check-input" type="radio" name="flexRadioDefault" id="flexRadioDefault1">
                                <label class="form-check-label" for="flexRadioDefault1">
                                    Giảm theo %
                                </label>
                                <input type="number" class="form-control mb-2 d-none pro-discpercent" placeholder="% giảm" value="" min="0" step="1000">
                            </div>
                            <div class="form-check mb-4">
                                <input class="form-check-input" type="radio" name="flexRadioDefault" id="flexRadioDefault2">
                                <label class="form-check-label" for="flexRadioDefault2">
                                    Giảm theo giá
                                </label>
                                <input type="number" class="form-control mb-2 d-none pro-discavailable" placeholder="Giá giảm có sẵn" value="" min="0" step="1000">
                                <input type="number" class="form-control mb-2 d-none pro-discpreorder" placeholder="Giá giảm đặt trước" value="" min="0" step="1000">
                            </div>
                        </div>
                        <div class="form-group mb-4">
                            <div class="d-flex align-items-center">
                                <input type="checkbox" class="pro-new mr-2" id="new">
                                <label class="mb-0" for="new">Mới</label>
                            </div>
                        </div>
                        <div class="form-group mb-4">
                            <div class="d-flex align-items-center">
                                <input type="checkbox" class="pro-legit mr-2" id="legit">
                                <label class="mb-0" for="legit">Chính hãng</label>
                            </div>
                        </div>
                        <div class="form-group mb-4">
                            <div class="d-flex align-items-center">
                                <input type="checkbox" class="pro-highlight mr-2" id="highlight">
                                <label class="mb-0" for="highlight">Nổi bật</label>
                            </div>
                        </div>
                        <div class="form-group mb-4">
                            <div class="d-flex align-items-center">
                                <input type="checkbox" class="pro-freereturn mr-2" id="return">
                                <label class="mb-0" for="return">Miễn phí giao hàng</label>
                            </div>
                        </div>
                        <div class="form-group mb-4">
                            <div class="d-flex align-items-center">
                                <input type="checkbox" class="pro-freedelivery mr-2" id="delivery">
                                <label class="mb-0" for="delivery">Đổi trả miễn phí</label>
                            </div>
                        </div>
                        <div class="form-group mb-4">
                            <label>Bảo hành</label>
                            <div class="d-flex align-items-center">
                                <input type="text" class="form-control pro-insurance">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Thương hiệu</label>
                            <div class="dropdown mb-2 mr-2">
                                <button class="btn border dropdown-toggle brand_select-text" type="button" data-toggle="dropdown">
                                    Thương hiệu
                                    <span class="caret"></span>
                                </button>
                                <ul class="dropdown-menu px-2" style="max-height: 300px; overflow: auto;">
                                    <input class="form-control mb-2" id="myInput" type="text" placeholder="Tìm thương hiệu..." autocomplete="off" />
                                    @foreach (var item in Model)
                                    {
                                        <li class="d-flex align-items-center">
                                            <input name="brand" class="brand_select mr-2" id="br_@item.BrandId" type="radio" value="@item.BrandId">
                                            <label class="mb-0" for="br_@item.BrandId">@item.BrandName</label>
                                        </li>
                                    }
                                </ul>
                            </div>
                        </div>
                        <div class="form-group subcategory-form">
                            <!-- SubCategory data -->
                        </div>
                    </div>
                    <div class="col-sm-6 mb-4">
                        <div class="attribute-form">

                        </div>
                        <div class="option-form">

                        </div>
                        <!-- Size guide -->
                        <div class="form-group mb-4">
                            <label>Hướng dẫn chọn kích thước</label>
                            <div class="d-flex flex-wrap">
                                <div class="">
                                    <div class="border" style="height: 100px; width: 100px;">
                                        <label class="mb-0 w-100 h-100 d-flex align-items-center justify-content-center"
                                               for="pic-size" style="cursor: pointer">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24"
                                                 height="24" viewBox="0 0 24 24" fill="none"
                                                 stroke="#ddd" stroke-width="1" stroke-linecap="round"
                                                 stroke-linejoin="round"
                                                 class="feather feather-plus-circle">
                                                <circle cx="12" cy="12" r="10"></circle>
                                                <line x1="12" y1="8" x2="12" y2="16"></line>
                                                <line x1="8" y1="12" x2="16" y2="12"></line>
                                            </svg>
                                        </label>
                                        <input type="file" class="form-control-file image-uploaded"
                                               id="pic-size" hidden>
                                        <div class="image-wrapper w-100 h-100 position-relative d-none align-items-center justify-content-center">
                                            <img class="mw-100 mh-100"
                                                 src="../assets/images/products/pro1.png" alt="">
                                            <span class="position-absolute remove-upload"
                                                  style="right: 0; top: 0; cursor: pointer;">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="18"
                                                     height="18" viewBox="0 0 24 24" fill="none"
                                                     stroke="red" stroke-width="1" stroke-linecap="round"
                                                     stroke-linejoin="round" class="feather feather-x">
                                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                                </svg>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-12 mb-4">
                        <div class="text-left mb-2 text-primary"><strong>Mô tả</strong></div>
                        <div class="form-group mb-4">
                            <textarea class="form-control" id="product-desciptions" rows="8"
                                      cols="50"></textarea>
                        </div>
                        <div class="mb-2 text-primary"><strong>Ảnh sản phẩm</strong></div>
                        <div class="form-group mb-4">
                            <label for="imageProduct-upload" class="input-tile mb-2">
                                <div class="d-flex">
                                    <a class="upload">Chọn ảnh</a>
                                    <div>(*Tối đa 10, tối thiểu 1)</div>
                                </div>
                            </label>
                            <input id="imageProduct-upload" type="file" multiple hidden />
                            <output class="d-flex flex-wrap" id="imageProduct-preview">
                            </output>
                        </div>
                        <div class="mb-2 text-primary"><strong>Ảnh thực tế</strong></div>
                        <div class="form-group mb-4">
                            <label for="imageUser-upload" class="input-tile mb-2">
                                <div class="d-flex">
                                    <a class="upload">Chọn ảnh</a>
                                    <div>(Tối đa 10, nếu có)</div>
                                </div>
                            </label>
                            <input id="imageUser-upload" type="file" multiple hidden />
                            <output class="d-flex flex-wrap" id="imageUser-preview">
                            </output>
                        </div>
                    </div>
                </div>
                <div class="text-center">
                    <button type="button" class="btn btn-secondary">Hủy</button>
                    <button type="button" class="btn btn-primary add-product">Lưu</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    // get subcategory
    $('.brand_select').change(function () {
        $.get('/api/CategoryAPI/getSubCategoryByBrandId', { id: $(this).val() })
            .then(function (response) {
                renderSubCategoryForm(response);
            })
            .catch(function (error) {
                alert(error.responseText);
            })
    })
    // get attribute and options+
    $(document).on('change', '.sub-category', function () {
        var _id = $(this).val()
        $.get('/api/CategoryAPI/getAttributesBySubCategoryId', { id: _id })
            .then(function (response) {
                renderAttributeForm(response);
            })
            .catch(function (error) {
                console.log(error);
                alert(error.responseText);
            })
        $.get('/api/CategoryAPI/getOptionsBySubCategoryId', { id: _id })
            .then(function (response) {
                renderOptionForm(response);
            })
            .catch(function (error) {
                console.log(error);
                alert(error.responseText);
            })
    })

    // Upload file
    var arrFilesSystem = [];
    var arrFilesUser = [];
    loadIamgesWithPreview("imageProduct-upload", "imageProduct-preview", arrFilesSystem);
    loadIamgesWithPreview("imageUser-upload", "imageUser-preview", arrFilesUser);
    function loadIamgesWithPreview(upload, preview, arr) {
        if (window.File && window.FileList && window.FileReader) {
            var filesInput = document.getElementById(upload);
            filesInput.addEventListener("change", function (event) {
                var files = event.target.files; //FileList object
                var currentFiles = $('.image__upload-item').length + files.length
                if (currentFiles > 10) {
                    return;
                }
                var output = document.getElementById(preview);
                for (var i = 0; i < files.length; i++) {
                    var file = files[i];
                    //Only pics
                    if (!file.type.match('image'))
                        continue;

                    arr.push(file);

                    var picReader = new FileReader();
                    picReader.fileName = file.name;
                    picReader.addEventListener("load", function (event) {
                        var picFile = event.target;
                        var div = document.createElement("div");
                        div.classList.add(`image__upload-item`, `mr-2`);
                        div.innerHTML = `
                            <div class="border mb-2 mx-auto" style="height: 100px; width: 100px;">
                                <div class="image-wrapper w-100 h-100 position-relative d-flex align-items-center justify-content-center">
                                    <img class="mw-100 mh-100" src="${picFile.result}" alt="${picFile.name}">
                                    <span class="position-absolute remove-upload"
                                        style="right: 0; top: 0; cursor: pointer;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18"
                                            height="18" viewBox="0 0 24 24" fill="none"
                                            stroke="red" stroke-width="1" stroke-linecap="round"
                                            stroke-linejoin="round" class="feather feather-x">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                    </span>
                                </div>
                            </div>
                        `;
                        var removeUpload = div.querySelector(".remove-upload");
                        removeUpload.addEventListener("click", function (evt) {
                            arr.forEach(function (file, index) {
                                if (file.name == event.target.fileName) {
                                    arr.splice(index, 1);
                                }
                            });
                            div.remove();
                            console.log(arr)
                        });
                        output.insertBefore(div, null);
                    });
                    //Read the image
                    picReader.readAsDataURL(file);
                }
            });
        }
    }

    // Add product
    $('.add-product').click(function () {
        var name = $(".pro-name").val();
        var description = tinymce.get("product-desciptions").getContent();
        var note = $(".pro-note").val();
        var brandId = $("input[name='brand']:checked").val();
        var subCategoryId = $("input[name='subCategory']:checked").val();
        var isNew = $('.pro-new').is(":checked") ? true : false;
        var isLegit = $('.pro-legit').is(":checked") ? true : false;
        var isHighlight = $('.pro-highlight').is(":checked") ? true : false;
        var isFreeReturn = $('.pro-freereturn').is(":checked") ? true : false;
        var isFreeDelivery = $('.pro-freedelivery').is(":checked") ? true : false;
        var insurance = $(".pro-insurance").val();
        var attributes = [];
        $('.attribute-values').each(function (index, item) {
            var attributeId = $(this).attr("id");
            var attribute = {
                id: attributeId,
                value: $(this).val()
            }
            attributes.push(attribute);
        })
        var currentOptions = [];
        var newOptions = [];
        $('.option-values').each(function (index, item) {
            var optionId = $(this).attr("id");
            var newOption = {
                id: optionId,
                values: []
            }
            var values = item.children
            for (var i = 0; i < values.length; i++) {
                if (values[i].firstElementChild.attributes.id) {
                    var id = values[i].firstElementChild.attributes.id.value;
                    currentOptions.push(id);
                } else {
                    var value = values[i].firstElementChild.textContent;
                    newOption.values.push(value);
                }
            }
            newOptions.push(newOption);
        })

        var formData = new FormData();
        formData.append('name', name);
        formData.append('description', description);
        formData.append('note', note);
        formData.append('brandId', brandId);
        formData.append('subCategoryId', subCategoryId);
        formData.append('isNew', isNew);
        formData.append('isLegit', isLegit);
        formData.append('isHighlight', isHighlight);
        formData.append('isFreeReturn', isFreeReturn);
        formData.append('isFreeDelivery', isFreeDelivery);
        formData.append('insurance', insurance);
        formData.append('attributes', JSON.stringify(attributes));
        formData.append('currentOptions', JSON.stringify(currentOptions));
        formData.append('newOptions', JSON.stringify(newOptions));
        for (let i = 0; i < arrFilesSystem.length; i++) {
            formData.append('systemImage', arrFilesSystem[i]);
        };
        for (let i = 0; i < arrFilesUser.length; i++) {
            formData.append('userImage', arrFilesUser[i]);
        };
        $.ajax({
            type: "POST",
            url: "/ManageProduct/AddProduct",
            data: formData, // In the controller it receives List<IFormFile> images
            processData: false,
            contentType: false,
            success: function (response) {
                alert(response);
                //location.reload();
            },
            error: function (error) {
                console.log(error);
            }
        });
    })

    // render data and html
    function renderSubCategoryForm(list) {
        $('.subcategory-form').empty();
        $('.attribute-form').empty();
        $('.option-form').empty();
        if (list.length) {
            $('.subcategory-form').append(htmlSubCategoryForm());
            list.forEach(function (item) {
                $('.subcate-list').append(htmlSubCategory(item.subCategoryId, item.subCategoryName));
            })
        }
    }
    function renderAttributeForm(list) {
        $('.attribute-form').empty();
        if (list.length) {
            $('.attribute-form').append(htmlAttributeForm());
            list.forEach(function (item) {
                $('.attribute-list').append(htmlAttribute(item));
            })
        }
    }
    function renderOptionForm(list) {
        $('.option-form').empty();
        if (list.length) {
            $('.option-form').append(htmlOptionForm());
            list.forEach(function (item) {
                $('.option-list').append(htmlOption(item));
            })
        }
    }

    // html
    function htmlSubCategoryForm() {
        return `
            <label>Danh mục sản phẩm</label>
            <div class="dropdown mb-2 mr-2">
                <button class="btn border dropdown-toggle subcategory_select-text" type="button" data-toggle="dropdown">
                    Danh mục
                    <span class="caret"></span>
                </button>
                <ul class="dropdown-menu px-2 subcate-list" style="max-height: 300px; overflow: auto;">
                    <input class="form-control mb-2" id="myInput" type="text" placeholder="Tìm danh mục.." autocomplete="off"/>

                </ul>
            </div>
        `;
    }
    function htmlSubCategory(id, name) {
        return `
            <li class="d-flex align-items-center">
                <input name="subCategory" class="mr-2 sub-category subcategory_select" id="attr_${id}" type="radio" value="${id}">
                <label class="mb-0" for="attr_${id}">${name}</label>
            </li>
        `;
    }
    function htmlOptionForm() {
        return `
            <div class="text-left mb-2 text-primary"><strong>Thông tin tùy chọn</strong></div>
            <div class="d-flex flex-wrap option-list">

            </div>
        `;
    }
    function htmlAttributeForm() {
        return `
            <div class="text-left mb-2 text-primary"><strong>Thông tin chi tiết</strong></div>
            <div class="d-flex flex-wrap attribute-list">

            </div>
        `;
    }
    function htmlOption(option) {
        var optionVal = '';
        $.ajax({
            url: '/ManageCategory/GetOptionValue',
            type: 'POST',
            data: { id: option.id },
            async: false,
            success: function (data) {
                temp = data;
                data.forEach(item => {
                    optionVal += `
                        <li class="d-inline p-1 mr-2 mb-2"
                            style="background-color: #ddd; border-radius: 4px;">
                            <span class="text" id="${item.id}">${item.value}</span>
                            <span class="remove-tag ml-2" style="cursor: pointer;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                    viewBox="0 0 24 24" fill="none" stroke="#333"
                                    stroke-width="1" stroke-linecap="round"
                                    stroke-linejoin="round" class="feather feather-x">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </span>
                        </li>
                    `;
                });
            }
        });
        
        return `
            <div class="form-group mr-4 mb-2">
                <label>${option.name}</label>
                <div class="d-flex mb-2">
                    <div class="dropdown mr-2">
                        <input class="form-control" type="text">
                    </div>
                    <a class="add-option btn btn-primary">Thêm</a>
                </div>
                <ul class="pl-0 option-values" id="${option.id}">
                    ${optionVal}
                </ul>
            </div>
        `;
    }
    function htmlAttribute(attr) {
        return `
            <div class="form-group mr-2">
                <label>${attr.name}</label>
                <input type="text" class="form-control attribute-values" id="${attr.id}">
            </div>
        `;
    }
</script>
<script>
    tinymce.init({
        selector: 'textarea',
        plugins: 'image autolink lists media table',
        toolbar: 'addcomment showcomments code image pageembed permanentpen table tableofcontents',
        toolbar_mode: 'floating',
        tinycomments_mode: 'embedded',
        tinycomments_author: 'Author name',
    });
</script>
<script type="text/javascript">
    // Search input with autocomplete
    $(document).ready(function () {
        $("#myInput").on("keyup", function () {
            var value = $(this).val().toLowerCase();
            $(".dropdown-menu li").filter(function () {
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
            });
        });
    });
</script>
<script type="text/javascript">
    $('.image-uploaded').change(function () {
        // Set image src
        let src = window.URL.createObjectURL(this.files[0]);
        $(this).siblings('.image-wrapper').children('img').attr('src', src);
        // hide label
        $(this).siblings('label').removeClass('d-flex');
        $(this).siblings('label').addClass('d-none');
        // display image
        $(this).siblings('.image-wrapper').removeClass('d-none');
        $(this).siblings('.image-wrapper').addClass('d-flex');
    })
    $('.remove-upload').click(function () {
        // Remove Image
        $(this).siblings('img').attr('src', '');
        // Hide image wrapper
        $(this).parent().removeClass('d-flex');
        $(this).parent().addClass('d-none');
        // Display label
        $(this).parent().siblings('label').removeClass('d-none');
        $(this).parent().siblings('label').addClass('d-flex');
    })
</script>
<script type="text/javascript">
    $(document).on('click', '.add-option', function () {
        let val = $(this).siblings('.dropdown').find('input').val();
        if (!val?.trim()) { return; }

        $(this).parent().siblings('ul').append(`
            <li class="d-inline p-1 mr-2 mb-2"
                style="background-color: #ddd; border-radius: 4px;">
                <span class="text">${val}</span>
                <span class="remove-tag ml-2" style="cursor: pointer;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                        viewBox="0 0 24 24" fill="none" stroke="#333"
                        stroke-width="1" stroke-linecap="round"
                        stroke-linejoin="round" class="feather feather-x">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </span>
            </li>
        `)

        $(this).siblings('.dropdown').find('input').val('');
    })
    $('.form-check-input').change(function () {
        $('.form-check-input').siblings('input').addClass('d-none');
        if ($(this).is(':checked')) {
            $(this).siblings('input').removeClass('d-none');
        }
    })
</script>
<script type="text/javascript">
    // Remove current banner
    $('.remove-tag').click(function () {
        $(this).parent().remove();
    })
    // Remove new added banner
    $(document).on('click', ".remove-tag", function () {
        $(this).parent().remove();
    });
</script>
<script>
    $('.brand_select').click(function () {
        var brandName = $(this).siblings('label').text();
        $('.brand_select-text').text(brandName);
    })
    $(document).on('click', '.subcategory_select', function () {
        var subcategoryName = $(this).siblings('label').text();
        $('.subcategory_select-text').text(subcategoryName);
    })
</script>